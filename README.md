# Copa Scout Scanner Plugin

This repository contains `copa-scout-scanner`, a scanner plugin for [Project Copacetic (copa)](https://github.com/project-copacetic/copacetic). This plugin enables `copa` to ingest vulnerability reports generated by [Docker Scout](https://www.docker.com/products/docker-scout/) in SARIF format and use this information to perform targeted patching of container images.

## Overview

-   **Docker Scout:** A tool from Docker providing container image analysis and vulnerability scanning. It can output vulnerability data in the standard SARIF (Static Analysis Results Interchange Format).
-   **Copacetic (`copa`):** A CNCF sandbox project for patching container images by directly updating vulnerable OS packages.
-   **`copa-scout` Plugin:** This program acts as a bridge. It reads a SARIF report file generated by `docker scout cves`, parses it, and transforms the vulnerability data into the `v1alpha1.UpdateManifest` JSON format that `copa` requires from its scanner plugins.

This allows users who leverage Docker Scout for vulnerability identification to use `copa` for the patching process based on those specific findings.

## Prerequisites

*   **Copacetic (`copa`) CLI:** Version 0.5.0 or later (which supports the scanner plugin architecture).
    *   Installation: [Copacetic Installation Guide](https://project-copacetic.github.io/copacetic/website/installation)
*   **Docker Scout CLI:** Must be installed and available in your `$PATH` (usually included with modern Docker Desktop or Docker Engine installations).
*   **Go (for building from source):** Version 1.21 or later (refer to the `go.mod` file for the exact version this plugin is built with).
*   A working Docker environment for `copa` to operate.

## Installation

You can install the `copa-scout-scanner` plugin using one of the following methods. After installation, ensure the `copa-scout-scanner` binary is in a directory listed in your system's `$PATH` environment variable.

**1. Using `go install`:**
   ```bash
   go install github.com/amanycodes/copa-scout-scanner
   ```

This will install the binary to your `$GOPATH/bin` or `$GOBIN` directory.

**2. Building from Source:**

See the [Development](#development) section below. After building, copy the `copa-scout` binary to a directory in your `$PATH`.


## Usage

The workflow involves two main steps:

**1. Generate a SARIF Vulnerability Report using Docker Scout:**

Use the `docker scout cves` command to scan your target image. Ensure you output the results in SARIF format to a file.

```bash
docker scout cves YOUR_TARGET_IMAGE:TAG --format sarif --output scout_report.sarif.json
```

Example:

```bash
docker scout cves nginx:1.21.6 --format sarif --output nginx_scout_report.sarif.json
```

**2. Run copa patch with the copa-scout Plugin:**

Use the `-s scout` flag to tell `copa` to use this plugin (as `copa` prefixes `copa-` to the scanner name, so it will look for `copa-scout`). Provide the path to the generated SARIF report using the `-r` flag.

```bash
copa patch \
  -i YOUR_TARGET_IMAGE:TAG \
  -r ./scout_report.sarif.json \
  -s scout
  # Add other copa flags as necessary (e.g., --debug, -t <patched_tag>)
```

Example for Docker Desktop on Linux:

```bash
copa patch \
  -i nginx:1.21.6 \
  -r ./nginx_scout_report.sarif.json \
  -s scout \
  --debug
```

`copa` will then execute:

```bash
copa-scout ./nginx_scout_report.sarif.json
```

It will read its JSON output (which is the `v1alpha1.UpdateManifest`), and proceed with patching.


## Development

To build the `copa-scout` plugin from source:

1. **Clone this repository:**

   ```bash
   git clone https://github.com/amanycodes/copa-scout-plugin.git
   cd copa-scout-plugin
   ```

2. **Ensure Go dependencies are present:**

   ```bash
   go mod tidy
   ```

3. **Build the plugin:**

   ```bash
   make build
   ```

This will produce the binary with the name specified in the `Makefile`, creating the `copa-scout` executable in the current directory.

---

## Testing the Plugin Directly

You can test the plugin's parsing and transformation logic by feeding it a SARIF file directly:

```bash
./copa-scout ./report.sarif.json
```

This will print the transformed `v1alpha1.UpdateManifest` JSON to your terminal's standard output. You can redirect this to a file for inspection:

```bash
./copa-scout ./report.sarif.json > transformed_manifest.json
```
## How It Works

The `copa-scout` plugin is a Go application designed to integrate with Copacetic's scanner plugin interface. It performs the following steps:

1. Accepts a file path to a Docker Scout-generated SARIF report as a command-line argument.
2. Parses this SARIF file using the [`go-sarif`](https://github.com/owenrumney/go-sarif) library.
3. Extracts relevant OS metadata (type, version, architecture) and vulnerability details (package name, installed version, fixed version, and CVE ID) from the SARIF structures. This involves careful parsing of SARIF rules, results, properties, and Package URLs (PURLs).
4. Transforms this extracted data into the precise JSON format specified by Copacetic's `v1alpha1.UpdateManifest` interface.
5. Prints the resulting `v1alpha1.UpdateManifest` JSON object to its standard output.
6. `copa` then reads this standard output to determine which OS packages need to be patched in the target container image.

## Contributing

Contributions, bug reports, and feature requests are welcome! Please feel free to open an issue or submit a pull request to this repository. If you encounter issues with parsing specific Docker Scout SARIF reports, please include a (sanitized, if necessary) sample of the SARIF that causes problems.
